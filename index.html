<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công Cụ Đánh Giá Video (V37 - Fix Lẫn Lộn Ưu/Nhược)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <!-- Lucide Icons (Vanilla) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s ease;
            overflow-x: hidden;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { border-radius: 10px; background-color: rgba(156, 163, 175, 0.5); }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: rgba(107, 114, 128, 0.8); }
        .chip { transition: all 0.2s; user-select: none; white-space: nowrap; }
        .chip:active { transform: scale(0.95); }
        
        @keyframes mic-pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }
        .mic-active { animation: mic-pulse 1.5s infinite; }
        
        @keyframes sparkle-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        .ai-loading { animation: sparkle-pulse 1s infinite; }

        .playlist-item-enter { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        * { transition: background-color 0.2s, border-color 0.2s, color 0.2s; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useMemo } = React;

        // --- THEME CONFIGURATION ---
        const THEMES = {
            blue: { id: 'blue', name: 'Xanh Hy Vọng', bg: 'bg-slate-50', headerBg: 'bg-white', headerBorder: 'border-slate-200', textMain: 'text-slate-800', textSub: 'text-slate-500', accent: 'text-blue-600', accentBg: 'bg-blue-50', buttonPrimary: 'bg-blue-600 hover:bg-blue-700 text-white', buttonSecondary: 'bg-white hover:bg-blue-50 text-blue-600 border border-blue-200', inputBg: 'bg-white', inputBorder: 'border-slate-300 focus:border-blue-500', cardBg: 'bg-white', cardBorder: 'border-slate-200', fileInputBtn: 'file:bg-blue-600 file:text-white hover:file:bg-blue-700', isDark: false },
            rose: { id: 'rose', name: 'Hồng Mộng Mơ', bg: 'bg-rose-50', headerBg: 'bg-white', headerBorder: 'border-rose-200', textMain: 'text-rose-900', textSub: 'text-rose-400', accent: 'text-rose-500', accentBg: 'bg-rose-50', buttonPrimary: 'bg-rose-500 hover:bg-rose-600 text-white', buttonSecondary: 'bg-white hover:bg-rose-50 text-rose-500 border border-rose-200', inputBg: 'bg-white', inputBorder: 'border-rose-200 focus:border-rose-400', cardBg: 'bg-white', cardBorder: 'border-rose-100', fileInputBtn: 'file:bg-rose-500 file:text-white hover:file:bg-rose-600', isDark: false },
            teal: { id: 'teal', name: 'Xanh Bạc Hà', bg: 'bg-teal-50', headerBg: 'bg-white', headerBorder: 'border-teal-200', textMain: 'text-teal-900', textSub: 'text-teal-500', accent: 'text-teal-600', accentBg: 'bg-teal-50', buttonPrimary: 'bg-teal-600 hover:bg-teal-700 text-white', buttonSecondary: 'bg-white hover:bg-teal-50 text-teal-600 border border-teal-200', inputBg: 'bg-white', inputBorder: 'border-teal-200 focus:border-teal-400', cardBg: 'bg-white', cardBorder: 'border-teal-100', fileInputBtn: 'file:bg-teal-600 file:text-white hover:file:bg-teal-700', isDark: false },
            amber: { id: 'amber', name: 'Nắng Ấm Áp', bg: 'bg-amber-50', headerBg: 'bg-white', headerBorder: 'border-amber-200', textMain: 'text-amber-900', textSub: 'text-amber-500', accent: 'text-amber-600', accentBg: 'bg-amber-50', buttonPrimary: 'bg-amber-500 hover:bg-amber-600 text-white', buttonSecondary: 'bg-white hover:bg-amber-50 text-amber-600 border border-amber-200', inputBg: 'bg-white', inputBorder: 'border-amber-200 focus:border-amber-400', cardBg: 'bg-white', cardBorder: 'border-amber-100', fileInputBtn: 'file:bg-amber-500 file:text-white hover:file:bg-amber-600', isDark: false },
            dark: { id: 'dark', name: 'Chế Độ Tối', bg: 'bg-slate-900', headerBg: 'bg-slate-800', headerBorder: 'border-slate-700', textMain: 'text-slate-100', textSub: 'text-slate-400', accent: 'text-blue-400', accentBg: 'bg-slate-800', buttonPrimary: 'bg-blue-600 hover:bg-blue-500 text-white', buttonSecondary: 'bg-slate-800 hover:bg-slate-700 text-blue-400 border border-slate-600', inputBg: 'bg-slate-800', inputBorder: 'border-slate-600 focus:border-blue-500', cardBg: 'bg-slate-800', cardBorder: 'border-slate-700', fileInputBtn: 'file:bg-slate-700 file:text-blue-400 hover:file:bg-slate-600', isDark: true }
        };

        // --- UPDATED SAMPLE PROMPTS (MIND MAP CONTEXT) ---
        const DEFAULT_PROS_SAMPLE = "Con đã bám sát sơ đồ tư duy của cô và trình bày các nhánh rất khoa học theo đúng chiều kim đồng hồ, giúp người nghe dễ dàng theo dõi mạch bài. Cô khen ngợi con không chỉ nói lại các từ khóa có sẵn mà còn biết mở rộng ý, đưa thêm ví dụ minh họa sinh động, chứng tỏ con hiểu bài rất sâu. Giọng nói của con to, rõ ràng, tốc độ nói vừa phải, và phong thái rất tự tin, đĩnh đạc.";
        
        const DEFAULT_CONS_SAMPLE = "Tuy nhiên, ở một vài nhánh, con vẫn còn phụ thuộc vào từ khóa trên sơ đồ, chỉ đọc lại mà chưa có sự diễn giải mở rộng thêm, khiến nội dung hơi đơn điệu. Con cần chú ý vị trí đứng để không che khuất sơ đồ khi thuyết trình. Ngoài ra, tốc độ nói ở phần cuối hơi nhanh, con hãy bình tĩnh và ngắt nghỉ đúng chỗ để bài nói mạch lạc hơn nhé.";

        // --- SAFE ICON COMPONENT ---
        const Icon = ({ name, className = "w-4 h-4", onClick }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current) {
                    ref.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    i.setAttribute('class', className);
                    ref.current.appendChild(i);
                    lucide.createIcons({ root: ref.current });
                }
            }, [name, className]);
            return <span ref={ref} onClick={onClick} className="inline-flex items-center justify-center cursor-pointer"></span>;
        };

        // --- HELPER FUNCTIONS ---
        const addTag = (currentVal, setter, text) => {
            let newVal = currentVal || "";
            let textToAdd = text;
            newVal = newVal.trimEnd();
            if (newVal.length > 0 && !newVal.endsWith(".") && !newVal.endsWith("\n")) {
                if (!newVal.endsWith(",")) newVal += ", ";
                else newVal += " ";
                textToAdd = text.charAt(0).toLowerCase() + text.slice(1);
            } else if (newVal.length > 0) {
                newVal += " ";
            }
            setter(newVal + textToAdd);
        };

        const formatTime = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `[${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}]`;
        };

        const callGeminiAI = async (apiKey, text, type, customPrompt, prosSample, consSample) => {
            let notes = text.trim();
            if (!notes) {
                notes = "Nhận xét chung dựa trên tiêu chí sơ đồ tư duy."; 
            }

            let systemInstruction = "Bạn là một giáo viên tiểu học đang chấm bài thuyết trình của học sinh dựa trên sơ đồ tư duy có sẵn.";
            
            const sampleText = type === 'pros' ? prosSample : consSample;
            
            // --- STRICT CONSTRAINTS TO FIX OVERLAP ---
            let constraint = "";
            if (type === 'pros') {
                constraint = "QUAN TRỌNG: Bạn đang viết vào phần 'Ưu Điểm'. Hãy CHỈ tập trung vào các điểm tốt, tích cực. TUYỆT ĐỐI KHÔNG dùng các từ chuyển ý phủ định như 'Tuy nhiên', 'Mặc dù vậy', 'Nhưng', 'Cần lưu ý', 'Hạn chế là'. Nếu đầu vào có ý chê/nhược điểm, hãy BỎ QUA nó, đừng viết vào đây.";
            } else {
                constraint = "QUAN TRỌNG: Bạn đang viết vào phần 'Góp Ý / Hạn Chế'. Hãy tập trung thẳng vào vấn đề cần cải thiện và đưa ra giải pháp khắc phục. KHÔNG cần khen lại những ý đã tốt để tránh lặp lại.";
            }

            systemInstruction += `\n\nĐây là BÀI MẪU CHUẨN (Gold Standard) để bạn học theo về văn phong:\n"${sampleText}"\n\n`;
            systemInstruction += `${constraint}\n\n`;
            systemInstruction += `Tiêu chí: Trình bày theo chiều kim đồng hồ, mở rộng ý (không chỉ đọc), giọng nói, phong thái. Xưng 'Cô' và gọi học sinh là 'Con'.`;

            if (customPrompt.trim()) {
                systemInstruction += `\nYêu cầu bổ sung: ${customPrompt}`;
            }

            const prompt = `Nội dung ghi chú/từ khóa: "${notes}"`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemInstruction }] }
                    })
                });
                if (response.ok) {
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || text;
                }
                throw new Error("API call failed.");
            } catch (error) {
                console.error("AI Error:", error);
                throw error;
            }
        };

        // --- COMPONENTS ---
        const SettingsModal = ({ isOpen, onClose, apiKey, setApiKey, customPrompt, setCustomPrompt, prosSample, setProsSample, consSample, setConsSample }) => {
            const [keyInput, setKeyInput] = useState(apiKey);
            const [promptInput, setPromptInput] = useState(customPrompt);
            const [prosInput, setProsInput] = useState(prosSample);
            const [consInput, setConsInput] = useState(consSample);

            useEffect(() => { 
                setKeyInput(apiKey); 
                setPromptInput(customPrompt);
                setProsInput(prosSample);
                setConsInput(consSample);
            }, [apiKey, customPrompt, prosSample, consSample, isOpen]);

            if (!isOpen) return null;
            
            const handleSave = () => {
                setApiKey(keyInput);
                setCustomPrompt(promptInput);
                setProsSample(prosInput);
                setConsSample(consInput);
                
                localStorage.setItem("gemini_api_key", keyInput);
                localStorage.setItem("ai_custom_prompt", promptInput);
                localStorage.setItem("ai_pros_sample", prosInput);
                localStorage.setItem("ai_cons_sample", consInput);
                onClose();
            };

            const resetSamples = () => {
                if(confirm("Khôi phục bài mẫu mặc định?")) {
                    setProsInput(DEFAULT_PROS_SAMPLE);
                    setConsInput(DEFAULT_CONS_SAMPLE);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-xl p-6 w-[800px] max-w-full shadow-2xl max-h-[90vh] overflow-y-auto custom-scrollbar">
                        <div className="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 className="font-bold text-lg flex items-center gap-2 text-purple-600"><Icon name="cpu" /> Cài Đặt AI & Mẫu</h3>
                            <button onClick={resetSamples} className="text-xs text-blue-600 hover:underline">Khôi phục mẫu gốc</button>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                             <div className="md:col-span-2">
                                <label className="block text-sm font-bold mb-1">Google Gemini API Key:</label>
                                <input type="password" value={keyInput} onChange={(e) => setKeyInput(e.target.value)} className="w-full p-2 border rounded-lg text-sm" placeholder="Dán API Key..." />
                            </div>
                            
                            <div className="md:col-span-2">
                                <label className="block text-sm font-bold mb-1">Hướng dẫn chung (Tùy chọn):</label>
                                <input type="text" value={promptInput} onChange={(e) => setPromptInput(e.target.value)} className="w-full p-2 border rounded-lg text-sm" placeholder="Ví dụ: 'Luôn viết ngắn gọn', 'Dùng từ hoa mỹ'..." />
                            </div>

                            <div>
                                <label className="block text-sm font-bold mb-1 text-green-700">Mẫu Ưu Điểm (AI sẽ học theo):</label>
                                <textarea value={prosInput} onChange={(e) => setProsInput(e.target.value)} rows="8" className="w-full p-2 border border-green-200 rounded-lg text-sm bg-green-50 focus:ring-1 focus:ring-green-500" placeholder="Nhập bài mẫu ưu điểm..." />
                            </div>

                            <div>
                                <label className="block text-sm font-bold mb-1 text-blue-700">Mẫu Góp Ý (AI sẽ học theo):</label>
                                <textarea value={consInput} onChange={(e) => setConsInput(e.target.value)} rows="8" className="w-full p-2 border border-blue-200 rounded-lg text-sm bg-blue-50 focus:ring-1 focus:ring-blue-500" placeholder="Nhập bài mẫu góp ý..." />
                            </div>
                        </div>

                        <div className="flex justify-end gap-2 pt-2 border-t">
                            <button onClick={onClose} className="px-4 py-2 bg-gray-200 rounded-lg text-sm font-bold">Đóng</button>
                            <button onClick={handleSave} className="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-bold shadow-md hover:bg-purple-700">Lưu Cài Đặt</button>
                        </div>
                    </div>
                </div>
            );
        };

        const AIButton = ({ text, onResult, type, apiKey, openSettings, customPrompt, prosSample, consSample }) => {
            const [isLoading, setIsLoading] = useState(false);
            const handleAI = async () => {
                if (!apiKey) return openSettings();
                setIsLoading(true);
                try {
                    const result = await callGeminiAI(apiKey, text, type, customPrompt, prosSample, consSample);
                    onResult(result.trim());
                } catch { alert("Lỗi AI. Kiểm tra API Key/Mạng."); } finally { setIsLoading(false); }
            };
            return (
                <button onClick={handleAI} disabled={isLoading} className={`flex items-center gap-1 px-3 py-1 rounded-full border transition-all shadow-sm ${isLoading ? 'bg-purple-100 border-purple-300 ai-loading text-purple-700' : 'bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600 text-white border-transparent'}`} title="AI Chấm Theo Mẫu">
                    <Icon name="sparkles" className="w-3.5 h-3.5" />
                    <span className="text-xs font-bold">AI Chấm</span>
                </button>
            );
        };

        const VoiceButton = ({ onTranscript, isDark }) => {
            const [isListening, setIsListening] = useState(false);
            const recognitionRef = useRef(null);
            useEffect(() => {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognitionRef.current = new SpeechRecognition();
                    recognitionRef.current.lang = 'vi-VN';
                    recognitionRef.current.onstart = () => setIsListening(true);
                    recognitionRef.current.onend = () => setIsListening(false);
                    recognitionRef.current.onresult = (event) => onTranscript(event.results[0][0].transcript);
                }
            }, [onTranscript]);
            const toggle = () => {
                if (!recognitionRef.current) return alert("Trình duyệt không hỗ trợ.");
                isListening ? recognitionRef.current.stop() : recognitionRef.current.start();
            };
            return (
                <button onClick={toggle} className={`p-1.5 rounded-full border transition-all ${isListening ? 'bg-red-500 text-white mic-active' : isDark ? 'bg-slate-700 text-slate-300' : 'bg-white text-slate-500'}`} title="Nhập giọng nói">
                    <Icon name={isListening ? "mic-off" : "mic"} className="w-4 h-4" />
                </button>
            );
        };

        const TimestampButton = ({ videoRef, contentState, setContent, isDark }) => {
            const insertTime = () => {
                if (videoRef.current) {
                    const timeTag = formatTime(videoRef.current.currentTime);
                    const newVal = (contentState || "").trimEnd();
                    setContent(newVal + (newVal ? " " : "") + timeTag + " ");
                } else alert("Chưa có video!");
            };
            return (
                <button onClick={insertTime} className={`p-1.5 rounded-full border transition-all ${isDark ? 'bg-slate-700 text-purple-400' : 'bg-white text-purple-500'}`} title="Chèn thời gian">
                    <Icon name="clock" className="w-4 h-4" />
                </button>
            );
        };

        const SimpleInputSection = ({ title, iconName, color, tags, state, setState, videoRef, theme, apiKey, openSettings, customPrompt, type, prosSample, consSample }) => {
            const colorClasses = {
                green: { bg: theme.isDark ? "bg-emerald-900/20" : "bg-emerald-50", border: theme.isDark ? "border-emerald-800" : "border-emerald-200", text: theme.isDark ? "text-emerald-400" : "text-emerald-700", chip: theme.isDark ? "bg-emerald-900 text-emerald-300 border-emerald-800" : "bg-white border-emerald-200 text-emerald-700 hover:bg-emerald-100" },
                blue: { bg: theme.isDark ? "bg-blue-900/20" : "bg-blue-50", border: theme.isDark ? "border-blue-800" : "border-blue-200", text: theme.isDark ? "text-blue-400" : "text-blue-700", chip: theme.isDark ? "bg-blue-900 text-blue-300 border-blue-800" : "bg-white border-blue-200 text-blue-700 hover:bg-blue-100" } 
            }[color];
            
            const handleAppend = (text, currentVal, setter) => {
                let newVal = currentVal || "";
                if (newVal && !newVal.endsWith(" ")) newVal += " ";
                setter(newVal + text);
            };

            return (
                <div className={`rounded-xl p-5 border ${colorClasses.bg} ${colorClasses.border} flex flex-col h-full shadow-sm transition-colors`}>
                    <div className="flex justify-between items-center mb-4">
                        <div className="flex items-center gap-2">
                            <Icon name={iconName} className={`w-6 h-6 ${color === 'green' ? 'text-emerald-500' : 'text-blue-500'}`} />
                            <h3 className={`font-bold text-xl ${colorClasses.text}`}>{title}</h3>
                        </div>
                        <div className="flex gap-2 items-center">
                            <AIButton text={state} onResult={setState} type={type} apiKey={apiKey} openSettings={openSettings} customPrompt={customPrompt} prosSample={prosSample} consSample={consSample} />
                            <div className="h-4 w-px bg-gray-300 mx-1"></div>
                            <TimestampButton videoRef={videoRef} contentState={state} setContent={setState} isDark={theme.isDark} />
                            <VoiceButton onTranscript={(txt) => handleAppend(txt, state, setState)} isDark={theme.isDark} />
                        </div>
                    </div>
                    
                    <div className="mb-4">
                        {Object.entries(tags).map(([category, items]) => (
                            <div key={category} className="mb-2 last:mb-0">
                                <div className={`text-[10px] font-bold uppercase opacity-60 mb-1 ${theme.textSub}`}>{category}</div>
                                <div className="flex flex-wrap gap-1.5">
                                    {items.map((t, i) => (
                                        <button key={i} onClick={() => addTag(state, setState, t)} className={`chip text-xs px-3 py-1.5 rounded-full border shadow-sm font-medium ${colorClasses.chip}`}>
                                            + {t}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>

                    <textarea 
                        value={state} 
                        onChange={e => setState(e.target.value)} 
                        rows={12}
                        className={`w-full flex-grow p-4 text-base border rounded-xl focus:outline-none focus:ring-2 focus:ring-opacity-50 resize-y shadow-inner transition-colors ${theme.inputBg} ${theme.inputBorder} ${theme.textMain} placeholder-gray-400`}
                        placeholder={`Chọn từ khóa hoặc nhập ý chính (Ví dụ: Đúng thứ tự, mở rộng ý tốt, nói hơi nhanh...)`}
                        style={{ minHeight: '200px' }}
                    ></textarea>
                </div>
            );
        };

        // --- PLAYLIST COMPONENT ---
        const PlaylistSection = ({ queue, currentId, onSelect, onDelete, onUpload, theme }) => {
            return (
                <div className={`flex flex-col h-full ${theme.cardBg} border ${theme.cardBorder} rounded-xl shadow-lg overflow-hidden`}>
                    <div className={`p-4 border-b ${theme.headerBorder} ${theme.headerBg} flex justify-between items-center shrink-0`}>
                        <h3 className={`font-bold ${theme.textMain} flex items-center gap-2`}>
                            <Icon name="list-video" className="w-5 h-5" /> Danh Sách Phát
                        </h3>
                        <span className={`text-xs font-bold px-2 py-1 rounded-full ${theme.accentBg} ${theme.accent}`}>{queue.length} video</span>
                    </div>

                    {/* Upload Button Area */}
                    <div className={`p-3 border-b ${theme.headerBorder} bg-gray-50/50 shrink-0`}>
                         <label className={`w-full cursor-pointer py-2.5 rounded-lg text-sm font-bold shadow-sm transition-all active:scale-95 ${theme.buttonPrimary} flex items-center justify-center gap-2`}>
                            <Icon name="folder-up" className="w-4 h-4" />
                            <span>Thêm Video Mới</span>
                            <input type="file" accept="video/*" multiple onChange={onUpload} onClick={e=>e.target.value=null} className="hidden" />
                        </label>
                    </div>

                    {/* Scrollable List */}
                    <div className="flex-grow overflow-y-auto custom-scrollbar p-2 space-y-2 min-h-0">
                        {queue.length === 0 ? (
                            <div className="text-center py-8 text-gray-400 text-sm italic">
                                Chưa có video nào.<br/>Vui lòng tải lên.
                            </div>
                        ) : (
                            queue.map((item, index) => {
                                const isPlaying = item.id === currentId;
                                return (
                                    <div 
                                        key={item.id} 
                                        onClick={() => onSelect(item.id)}
                                        className={`playlist-item-enter relative p-3 rounded-lg border cursor-pointer transition-all hover:shadow-md flex items-center gap-3 ${isPlaying ? `${theme.accentBg} ${theme.accent} border-blue-300 ring-1 ring-blue-300` : `${theme.cardBg} ${theme.textMain} border-transparent hover:bg-gray-100`}`}
                                    >
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center shrink-0 ${isPlaying ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-500'}`}>
                                            {isPlaying ? <Icon name="play" className="w-4 h-4 fill-current" /> : <span className="text-xs font-bold">{index + 1}</span>}
                                        </div>
                                        
                                        <div className="flex-grow min-w-0">
                                            <div className="truncate font-medium text-sm" title={item.name}>{item.name}</div>
                                            {isPlaying && <div className="text-[10px] uppercase font-bold tracking-wider opacity-70">Đang phát</div>}
                                        </div>

                                        <button 
                                            onClick={(e) => { e.stopPropagation(); onDelete(item.id); }}
                                            className="p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors"
                                            title="Xóa khỏi danh sách"
                                        >
                                            <Icon name="x" className="w-4 h-4" />
                                        </button>
                                    </div>
                                )
                            })
                        )}
                    </div>
                </div>
            );
        };

        function App() {
            const [currentThemeId, setCurrentThemeId] = useState(() => localStorage.getItem("app_theme_v17") || 'blue');
            const theme = THEMES[currentThemeId];
            const [activeTab, setActiveTab] = useState('assess'); // 'assess' | 'list'

            const [folders, setFolders] = useState(() => {
                const saved = localStorage.getItem("video_reviews_data_v24");
                return saved ? JSON.parse(saved) : [{ id: 'default_1', name: 'Lớp 5A', reviews: [] }];
            });
            const [activeFolderId, setActiveFolderId] = useState(() => localStorage.getItem("active_folder_id_v24") || folders[0].id);
            
            // --- VIDEO QUEUE STATE ---
            const [videoQueue, setVideoQueue] = useState([]);
            const [currentVideoId, setCurrentVideoId] = useState(null);
            
            const currentVideo = videoQueue.find(v => v.id === currentVideoId);
            const videoUrl = currentVideo?.url || null;

            const [presenterName, setPresenterName] = useState("");
            const [pros, setPros] = useState("");
            const [cons, setCons] = useState("");
            const [searchTerm, setSearchTerm] = useState("");
            const [editingKey, setEditingKey] = useState(null);

            // --- AI SETTINGS ---
            const [apiKey, setApiKey] = useState(() => localStorage.getItem("gemini_api_key") || "");
            const [customPrompt, setCustomPrompt] = useState(() => localStorage.getItem("ai_custom_prompt") || "");
            const [prosSample, setProsSample] = useState(() => localStorage.getItem("ai_pros_sample") || DEFAULT_PROS_SAMPLE);
            const [consSample, setConsSample] = useState(() => localStorage.getItem("ai_cons_sample") || DEFAULT_CONS_SAMPLE);
            const [showSettings, setShowSettings] = useState(false);

            const videoRef = useRef(null);
            
            const activeFolder = folders.find(f => f.id === activeFolderId) || folders[0];
            const reviews = activeFolder.reviews;

            const filteredReviews = useMemo(() => {
                return reviews.filter(r => 
                    r.presenter.toLowerCase().includes(searchTerm.toLowerCase()) || 
                    (r.fileName && r.fileName.toLowerCase().includes(searchTerm.toLowerCase()))
                );
            }, [reviews, searchTerm]);

            // --- SUGGESTION TAGS (UPDATED V36) ---
            const suggestionTags = {
                pros: {
                    "Nội Dung (Sơ Đồ Tư Duy)": [
                        "Trình bày đúng chiều kim đồng hồ", "Biết mở rộng ý từ khóa", "Liên kết các nhánh logic", "Hiểu sâu nội dung sơ đồ",
                        "Dẫn chứng ví dụ sinh động", "Không phụ thuộc tài liệu", "Diễn đạt mạch lạc", "Nội dung đầy đủ, chi tiết",
                        "Phần mở rộng rất hay", "Kết nối các ý tự nhiên"
                    ],
                    "Hình Thức": [
                        "Giọng to, rõ ràng", "Tốc độ nói vừa phải", "Phong thái tự tin", "Đứng góc hợp lý", "Không che khuất sơ đồ",
                        "Dùng que chỉ dứt khoát", "Tương tác mắt tốt", "Biểu cảm tươi tắn", "Cử chỉ tay tự nhiên", "Ngắt nghỉ đúng chỗ"
                    ],
                    "Khác": [
                        "Sáng tạo", "Lôi cuốn", "Năng lượng tích cực", "Mở bài ấn tượng", "Kết thúc sâu sắc"
                    ]
                },
                cons: {
                    "Nội Dung (Sơ Đồ Tư Duy)": [
                        "Trình bày lộn xộn (chưa theo chiều)", "Chỉ đọc lại từ khóa", "Thiếu sự mở rộng ý", "Nội dung còn sơ sài",
                        "Chưa hiểu rõ liên kết nhánh", "Phụ thuộc vào giấy/sơ đồ", "Diễn đạt còn lủng củng", "Quên ý quan trọng",
                        "Cần bổ sung ví dụ", "Chưa thoát ly tài liệu"
                    ],
                    "Hình Thức": [
                        "Nói quá nhanh", "Nói quá chậm/ề à", "Giọng nói nhỏ/lí nhí", "Che mất sơ đồ", "Đứng quay lưng xuống lớp",
                        "Quên dùng que chỉ", "Ít tương tác mắt", "Cử chỉ thừa nhiều", "Thiếu tự tin", "Trang phục chưa chỉnh tề"
                    ]
                }
            };

            useEffect(() => {
                localStorage.setItem("app_theme_v17", currentThemeId);
                document.body.className = theme.bg;
            }, [currentThemeId, theme]);

            useEffect(() => {
                localStorage.setItem("video_reviews_data_v24", JSON.stringify(folders));
                localStorage.setItem("active_folder_id_v24", activeFolderId);
            }, [folders, activeFolderId]);

            const handleBatchFileChange = (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;
                const newQueueItems = files.map(file => ({
                    id: Date.now() + Math.random(),
                    file: file,
                    url: URL.createObjectURL(file),
                    name: file.name
                }));
                const firstNewVideoId = newQueueItems[0].id;
                
                if (!currentVideoId) {
                     setPresenterName(newQueueItems[0].name.replace(/\.[^/.]+$/, ""));
                     setCurrentVideoId(firstNewVideoId);
                }
                setVideoQueue(prev => [...prev, ...newQueueItems]);
            };

            const openVideoFromQueue = (id) => {
                const videoToOpen = videoQueue.find(v => v.id === id);
                if (videoToOpen) {
                    setCurrentVideoId(id);
                    if (!editingKey) {
                        setPresenterName(videoToOpen.name.replace(/\.[^/.]+$/, ""));
                        setPros("");
                        setCons("");
                    }
                }
            };

            const deleteVideoFromQueue = (id) => {
                const updatedQueue = videoQueue.filter(v => v.id !== id);
                setVideoQueue(updatedQueue);
                if (currentVideoId === id) {
                    if (updatedQueue.length > 0) openVideoFromQueue(updatedQueue[0].id);
                    else {
                        setCurrentVideoId(null);
                        setPresenterName("");
                    }
                }
            };

            // Folder Handlers
            const createFolder = () => {
                const name = prompt("Tên lớp mới:");
                if (name) {
                    const newF = { id: 'f_' + Date.now(), name, reviews: [] };
                    setFolders([...folders, newF]); setActiveFolderId(newF.id);
                }
            };
            const renameFolder = () => {
                const name = prompt("Đổi tên lớp:", activeFolder.name);
                if (name) setFolders(folders.map(f => f.id === activeFolderId ? { ...f, name } : f));
            };
            const deleteFolder = () => {
                if (folders.length <= 1) return alert("Giữ lại ít nhất 1 lớp!");
                if (confirm("Xóa lớp này?")) {
                    const rem = folders.filter(f => f.id !== activeFolderId);
                    setFolders(rem); setActiveFolderId(rem[0].id);
                }
            };

            // Export/Import
            const handleExportData = () => {
                const dataStr = JSON.stringify(folders, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `Du_Lieu_Cham_Bai_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleImportData = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (Array.isArray(importedData)) {
                            if (confirm("Khôi phục dữ liệu? Dữ liệu hiện tại sẽ mất.")) {
                                setFolders(importedData);
                                setActiveFolderId(importedData[0]?.id);
                                alert("Thành công!");
                            }
                        } else alert("File lỗi.");
                    } catch (err) { alert("Lỗi đọc file."); }
                };
                reader.readAsText(file);
                e.target.value = null;
            };

            const handleSave = () => {
                if (!presenterName) return alert("Vui lòng nhập tên học sinh!");
                if (editingKey) {
                    const updatedFolders = folders.map(f => {
                        if (f.id === activeFolderId) {
                            return {
                                ...f,
                                reviews: f.reviews.map(r => r.key === editingKey ? { ...r, presenter: presenterName, pros, cons } : r)
                            };
                        }
                        return f;
                    });
                    setFolders(updatedFolders);
                    setEditingKey(null);
                    alert("Đã cập nhật!");
                } else {
                    const newId = (reviews.length > 0 ? Math.max(...reviews.map(r => r.id)) : 0) + 1;
                    const newRev = {
                        key: Date.now(), id: newId, 
                        fileName: currentVideo?.name || "N/A", 
                        presenter: presenterName,
                        pros: pros, cons: cons,
                        date: new Date().toLocaleString('vi-VN')
                    };
                    setFolders(folders.map(f => f.id === activeFolderId ? { ...f, reviews: [newRev, ...f.reviews] } : f));
                    alert(`Đã lưu bài của em ${presenterName}!`);
                    
                    if (currentVideo) {
                        const currentIndex = videoQueue.findIndex(v => v.id === currentVideoId);
                        if (currentIndex !== -1 && currentIndex < videoQueue.length - 1) {
                            openVideoFromQueue(videoQueue[currentIndex + 1].id);
                        }
                    }
                }
                if (!editingKey) { setPros(""); setCons(""); setPresenterName(""); }
            };

            const handleEdit = (review) => {
                setEditingKey(review.key);
                setPresenterName(review.presenter);
                setPros(review.pros);
                setCons(review.cons);
                setActiveTab('assess'); // Switch to Assess tab automatically
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const cancelEdit = () => {
                setEditingKey(null);
                setPros(""); setCons(""); setPresenterName("");
            };

            const exportAllExcel = () => {
                const wb = XLSX.utils.book_new();
                folders.forEach(f => {
                    if(!f.reviews.length) return;
                    const data = [...f.reviews].sort((a,b)=>a.id-b.id).map(r => ({ "STT": r.id, "Học Sinh": r.presenter, "Ưu Điểm": r.pros, "Góp Ý": r.cons }));
                    const ws = XLSX.utils.json_to_sheet(data);
                    ws['!cols'] = [{wch:5}, {wch:25}, {wch:50}, {wch:50}];
                    XLSX.utils.book_append_sheet(wb, ws, f.name.slice(0,30));
                });
                XLSX.writeFile(wb, `Danh_Gia_${new Date().getTime()}.xlsx`);
            };

            return (
                <div className={`min-h-screen p-4 flex flex-col ${theme.bg} transition-colors duration-300`}>
                    <div className="w-full max-w-[1920px] mx-auto space-y-4 flex-grow flex flex-col">
                        
                        {/* HEADER */}
                        <div className={`${theme.headerBg} p-3 rounded-xl shadow-sm border ${theme.headerBorder} flex flex-col lg:flex-row justify-between items-center gap-4 shrink-0`}>
                            <h1 className={`text-xl font-bold ${theme.textMain} flex items-center gap-2`}>
                                <span className={`${theme.accentBg} p-1.5 rounded-lg`}><Icon name="check-square" className={`w-6 h-6 ${theme.accent}`} /></span>
                                Chấm Video V37
                            </h1>
                            <div className="flex flex-wrap justify-center items-center gap-4">
                                <div className="flex gap-2">
                                    <button onClick={() => setShowSettings(true)} className={`p-2 ${theme.textSub} hover:${theme.accentBg} rounded-lg`} title="Cài đặt AI & Mẫu Nhận Xét"><Icon name="settings" /></button>
                                    <button onClick={handleExportData} className={`p-2 ${theme.textSub} hover:${theme.accentBg} rounded-lg`} title="Sao lưu"><Icon name="download" /></button>
                                    <label className={`p-2 ${theme.textSub} hover:${theme.accentBg} rounded-lg cursor-pointer`} title="Khôi phục"><Icon name="upload" /><input type="file" accept=".json" onChange={handleImportData} className="hidden" /></label>
                                </div>
                                <div className={`h-6 w-px ${theme.isDark ? 'bg-slate-600' : 'bg-slate-200'}`}></div>
                                <div className={`flex items-center gap-2 ${theme.accentBg} p-1.5 rounded-lg border ${theme.headerBorder}`}>
                                    {Object.values(THEMES).map(t => (
                                        <button key={t.id} onClick={() => setCurrentThemeId(t.id)} className={`w-5 h-5 rounded-full border-2 transition-all ${currentThemeId === t.id ? 'border-blue-500 scale-125' : 'border-transparent opacity-70'}`} style={{ backgroundColor: t.isDark ? '#334155' : (t.id === 'blue' ? '#3b82f6' : t.id === 'rose' ? '#f43f5e' : t.id === 'teal' ? '#14b8a6' : '#f59e0b') }}></button>
                                    ))}
                                </div>
                                <div className={`flex items-center gap-3 ${theme.isDark ? 'bg-slate-700' : 'bg-slate-100'} p-1.5 rounded-lg border ${theme.headerBorder}`}>
                                    <select value={activeFolderId} onChange={e=>setActiveFolderId(e.target.value)} className={`bg-transparent font-bold ${theme.textMain} outline-none cursor-pointer min-w-[120px] text-sm`}>
                                        {folders.map(f => <option key={f.id} value={f.id} className="text-black">{f.name} ({f.reviews.length})</option>)}
                                    </select>
                                    <button onClick={createFolder} className={`p-1.5 ${theme.textMain} hover:${theme.accentBg} rounded-lg`}><Icon name="plus" className="w-4 h-4" /></button>
                                    <button onClick={renameFolder} className={`p-1.5 ${theme.textMain} hover:${theme.accentBg} rounded-lg`}><Icon name="pencil" className="w-4 h-4" /></button>
                                    <button onClick={deleteFolder} className={`p-1.5 text-red-500 hover:bg-red-50 rounded-lg`}><Icon name="trash-2" className="w-4 h-4" /></button>
                                </div>
                            </div>
                        </div>

                        {/* MAIN LAYOUT: 2 COLUMNS WITH STICKY LEFT */}
                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
                            
                            {/* LEFT COLUMN: STICKY (Video Player & Playlist) */}
                            <div className="lg:col-span-5 flex flex-col gap-4 sticky top-4 self-start h-[calc(100vh-2rem)] overflow-hidden">
                                {/* Video Player - Fixed Height Ratio */}
                                <div className={`rounded-xl shadow-lg overflow-hidden flex flex-col border ${theme.isDark ? 'border-slate-700 bg-slate-800' : 'border-slate-200 bg-white'} shrink-0 aspect-video max-h-[40vh]`}>
                                    <div className="flex-grow flex items-center justify-center bg-black min-h-0 relative h-full">
                                        {videoUrl ? (
                                            <video key={videoUrl} ref={videoRef} src={videoUrl} controls className="w-full h-full object-contain" />
                                        ) : (
                                            <div className="text-gray-500 text-center flex flex-col items-center p-10">
                                                <Icon name="monitor-play" className="w-12 h-12 mb-3 opacity-50 text-white" />
                                                <p className="text-sm text-slate-400">Chọn video để phát</p>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* Playlist - Takes remaining height */}
                                <PlaylistSection 
                                    queue={videoQueue} 
                                    currentId={currentVideoId} 
                                    onSelect={openVideoFromQueue}
                                    onDelete={deleteVideoFromQueue}
                                    onUpload={handleBatchFileChange}
                                    theme={theme}
                                />
                            </div>

                            {/* RIGHT COLUMN: SCROLLABLE TABS */}
                            <div className="lg:col-span-7 flex flex-col gap-4 min-h-0">
                                
                                {/* TABS NAVIGATION */}
                                <div className={`flex p-1 rounded-xl ${theme.isDark ? 'bg-slate-800' : 'bg-slate-200'} self-start`}>
                                    <button 
                                        onClick={() => setActiveTab('assess')}
                                        className={`px-6 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all ${activeTab === 'assess' ? `${theme.cardBg} ${theme.accent} shadow-sm` : `${theme.textSub} hover:${theme.textMain}`}`}
                                    >
                                        <Icon name="edit-3" className="w-4 h-4" /> Chấm Bài
                                    </button>
                                    <button 
                                        onClick={() => setActiveTab('list')}
                                        className={`px-6 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all ${activeTab === 'list' ? `${theme.cardBg} ${theme.accent} shadow-sm` : `${theme.textSub} hover:${theme.textMain}`}`}
                                    >
                                        <Icon name="list" className="w-4 h-4" /> Danh Sách Đã Chấm ({filteredReviews.length})
                                    </button>
                                </div>

                                {/* TAB CONTENT */}
                                {activeTab === 'assess' && (
                                    <div className={`${theme.cardBg} rounded-2xl shadow-lg border ${theme.cardBorder} p-6 relative animate-fadeIn`}>
                                        {editingKey && (
                                            <div className="absolute top-0 left-0 w-full bg-orange-100 text-orange-700 px-4 py-2 text-sm font-bold text-center border-b border-orange-200 rounded-t-2xl flex justify-between items-center animate-pulse">
                                                <span>ĐANG CHỈNH SỬA: {presenterName}</span>
                                                <button onClick={cancelEdit} className="hover:text-red-600 underline">Thoát</button>
                                            </div>
                                        )}

                                        <div className={`mb-6 ${editingKey ? 'mt-8' : ''}`}>
                                            <label className={`block text-xs font-bold uppercase mb-2 ${theme.textSub}`}>Họ và tên học sinh:</label>
                                            <input type="text" value={presenterName} onChange={e=>setPresenterName(e.target.value)} placeholder="Nhập tên học sinh..." className={`w-full ${theme.inputBg} border ${theme.inputBorder} rounded-xl px-5 py-4 font-bold text-2xl focus:ring-2 focus:ring-opacity-50 focus:outline-none ${theme.textMain} placeholder-slate-400 shadow-sm`} />
                                        </div>

                                        <div className="flex flex-col gap-6">
                                            <div className="w-full min-h-[300px]">
                                                <SimpleInputSection 
                                                    title="Ưu Điểm (Điểm Đạt)" iconName="check-circle-2" color="green" tags={suggestionTags.pros} state={pros} setState={setPros} videoRef={videoRef} theme={theme} 
                                                    apiKey={apiKey} openSettings={()=>setShowSettings(true)} customPrompt={customPrompt} type="pros" prosSample={prosSample} consSample={consSample}
                                                />
                                            </div>
                                            <div className="w-full min-h-[300px]">
                                                <SimpleInputSection 
                                                    title="Góp Ý / Hạn Chế" iconName="message-circle" color="blue" tags={suggestionTags.cons} state={cons} setState={setCons} videoRef={videoRef} theme={theme} 
                                                    apiKey={apiKey} openSettings={()=>setShowSettings(true)} customPrompt={customPrompt} type="cons" prosSample={prosSample} consSample={consSample}
                                                />
                                            </div>
                                        </div>

                                        <div className="mt-8 flex justify-end gap-3 sticky bottom-0 bg-opacity-90 backdrop-blur-sm py-4 border-t border-dashed border-gray-200">
                                            {editingKey && <button onClick={cancelEdit} className="px-6 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-200 transition-all">Hủy</button>}
                                            <button onClick={handleSave} className={`${theme.buttonPrimary} px-10 py-3 rounded-xl font-bold shadow-lg flex items-center gap-2 transform active:scale-95 transition-all text-lg`}>
                                                <Icon name={editingKey ? "rotate-ccw" : "save"} className="w-6 h-6" /> {editingKey ? "CẬP NHẬT" : "LƯU KẾT QUẢ"}
                                            </button>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'list' && (
                                    <div className={`${theme.cardBg} rounded-2xl shadow-lg border ${theme.cardBorder} p-6 flex flex-col transition-colors animate-fadeIn min-h-[600px]`}>
                                        <div className="flex flex-col md:flex-row justify-between items-center mb-4 shrink-0 gap-3">
                                            <div className="flex items-center gap-3 w-full md:w-auto flex-grow">
                                                <div className={`flex items-center gap-2 ${theme.inputBg} border ${theme.inputBorder} px-3 py-2 rounded-lg w-full`}>
                                                    <Icon name="search" className={theme.textSub} />
                                                    <input type="text" placeholder="Tìm kiếm tên học sinh..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className={`bg-transparent outline-none text-sm w-full ${theme.textMain}`} />
                                                    {searchTerm && <button onClick={() => setSearchTerm("")}><Icon name="x" className="w-4 h-4 text-gray-400" /></button>}
                                                </div>
                                            </div>
                                            <button onClick={exportAllExcel} className={`${theme.buttonSecondary} px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 whitespace-nowrap`}>
                                                <Icon name="file-spreadsheet" /> Xuất Excel
                                            </button>
                                        </div>
                                        
                                        <div className="overflow-x-auto custom-scrollbar flex-grow rounded-xl border border-slate-200/50">
                                            <table className="w-full text-left border-collapse relative">
                                                <thead className={`${theme.isDark ? 'bg-slate-700 text-slate-300' : 'bg-slate-100 text-slate-600'} uppercase font-bold text-sm sticky top-0 z-10 shadow-sm`}>
                                                    <tr>
                                                        <th className="px-4 py-4 text-center w-12">#</th>
                                                        <th className="px-4 py-4 w-1/5">Học Sinh</th>
                                                        <th className="px-4 py-4 w-1/3">Ưu Điểm</th>
                                                        <th className="px-4 py-4 w-1/3">Góp Ý</th>
                                                        <th className="px-4 py-4 text-center w-24">Thao Tác</th>
                                                    </tr>
                                                </thead>
                                                <tbody className={`divide-y ${theme.isDark ? 'divide-slate-700' : 'divide-slate-100'} text-sm`}>
                                                    {filteredReviews.length === 0 ? <tr><td colSpan="6" className={`text-center py-12 ${theme.textSub} italic`}>Chưa có dữ liệu</td></tr> : 
                                                    [...filteredReviews].reverse().map(r => (
                                                        <tr key={r.key} className={`${theme.isDark ? 'hover:bg-slate-700' : 'hover:bg-blue-50'} transition-colors group`}>
                                                            <td className={`px-4 py-4 text-center ${theme.textSub}`}>{r.id}</td>
                                                            <td className={`px-4 py-4 font-bold ${theme.textMain} align-top`}>
                                                                <div className="text-base">{r.presenter}</div>
                                                                <div className={`text-xs ${theme.textSub} mt-1 font-normal flex items-center gap-1`}>
                                                                    <Icon name="clock" className="w-3 h-3" /> {r.date}
                                                                </div>
                                                            </td>
                                                            <td className={`px-4 py-4 ${theme.textMain} whitespace-pre-line align-top`}>{r.pros}</td>
                                                            <td className={`px-4 py-4 ${theme.textMain} whitespace-pre-line align-top`}>{r.cons}</td>
                                                            <td className="px-4 py-4 text-center align-top pt-4">
                                                                <div className="flex justify-center gap-2 opacity-60 group-hover:opacity-100 transition-opacity">
                                                                    <button onClick={() => handleEdit(r)} className="text-blue-600 bg-blue-50 p-2 rounded-lg hover:bg-blue-100" title="Sửa"><Icon name="pencil" /></button>
                                                                    <button onClick={() => {if(confirm("Xóa?")) setFolders(folders.map(f=>f.id===activeFolderId?{...f,reviews:f.reviews.filter(rev=>rev.key!==r.key)}:f))}} className="text-red-600 bg-red-50 p-2 rounded-lg hover:bg-red-100" title="Xóa"><Icon name="trash-2" /></button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                    <SettingsModal isOpen={showSettings} onClose={() => setShowSettings(false)} apiKey={apiKey} setApiKey={setApiKey} customPrompt={customPrompt} setCustomPrompt={setCustomPrompt} prosSample={prosSample} setProsSample={setProsSample} consSample={consSample} setConsSample={setConsSample} />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
