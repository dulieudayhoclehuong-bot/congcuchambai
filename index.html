<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công Cụ Đánh Giá Video (V25 - AI Powered)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <!-- Lucide Icons (Vanilla) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s ease;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { border-radius: 10px; background-color: rgba(156, 163, 175, 0.5); }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: rgba(107, 114, 128, 0.8); }
        .chip { transition: all 0.2s; user-select: none; white-space: nowrap; }
        .chip:active { transform: scale(0.95); }
        @keyframes mic-pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }
        .mic-active { animation: mic-pulse 1.5s infinite; }
        
        @keyframes sparkle-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        .ai-loading { animation: sparkle-pulse 1s infinite; }

        * { transition: background-color 0.2s, border-color 0.2s, color 0.2s; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useMemo } = React;

        // --- THEME CONFIGURATION ---
        const THEMES = {
            blue: { id: 'blue', name: 'Xanh Hy Vọng', bg: 'bg-slate-50', headerBg: 'bg-white', headerBorder: 'border-slate-200', textMain: 'text-slate-800', textSub: 'text-slate-500', accent: 'text-blue-600', accentBg: 'bg-blue-50', buttonPrimary: 'bg-blue-600 hover:bg-blue-700 text-white', buttonSecondary: 'bg-white hover:bg-blue-50 text-blue-600 border border-blue-200', inputBg: 'bg-white', inputBorder: 'border-slate-300 focus:border-blue-500', cardBg: 'bg-white', cardBorder: 'border-slate-200', fileInputBtn: 'file:bg-blue-600 file:text-white hover:file:bg-blue-700', isDark: false },
            rose: { id: 'rose', name: 'Hồng Mộng Mơ', bg: 'bg-rose-50', headerBg: 'bg-white', headerBorder: 'border-rose-200', textMain: 'text-rose-900', textSub: 'text-rose-400', accent: 'text-rose-500', accentBg: 'bg-rose-50', buttonPrimary: 'bg-rose-500 hover:bg-rose-600 text-white', buttonSecondary: 'bg-white hover:bg-rose-50 text-rose-500 border border-rose-200', inputBg: 'bg-white', inputBorder: 'border-rose-200 focus:border-rose-400', cardBg: 'bg-white', cardBorder: 'border-rose-100', fileInputBtn: 'file:bg-rose-500 file:text-white hover:file:bg-rose-600', isDark: false },
            teal: { id: 'teal', name: 'Xanh Bạc Hà', bg: 'bg-teal-50', headerBg: 'bg-white', headerBorder: 'border-teal-200', textMain: 'text-teal-900', textSub: 'text-teal-500', accent: 'text-teal-600', accentBg: 'bg-teal-50', buttonPrimary: 'bg-teal-600 hover:bg-teal-700 text-white', buttonSecondary: 'bg-white hover:bg-teal-50 text-teal-600 border border-teal-200', inputBg: 'bg-white', inputBorder: 'border-teal-200 focus:border-teal-400', cardBg: 'bg-white', cardBorder: 'border-teal-100', fileInputBtn: 'file:bg-teal-600 file:text-white hover:file:bg-teal-700', isDark: false },
            amber: { id: 'amber', name: 'Nắng Ấm Áp', bg: 'bg-amber-50', headerBg: 'bg-white', headerBorder: 'border-amber-200', textMain: 'text-amber-900', textSub: 'text-amber-500', accent: 'text-amber-600', accentBg: 'bg-amber-50', buttonPrimary: 'bg-amber-500 hover:bg-amber-600 text-white', buttonSecondary: 'bg-white hover:bg-amber-50 text-amber-600 border border-amber-200', inputBg: 'bg-white', inputBorder: 'border-amber-200 focus:border-amber-400', cardBg: 'bg-white', cardBorder: 'border-amber-100', fileInputBtn: 'file:bg-amber-500 file:text-white hover:file:bg-amber-600', isDark: false },
            dark: { id: 'dark', name: 'Chế Độ Tối', bg: 'bg-slate-900', headerBg: 'bg-slate-800', headerBorder: 'border-slate-700', textMain: 'text-slate-100', textSub: 'text-slate-400', accent: 'text-blue-400', accentBg: 'bg-slate-800', buttonPrimary: 'bg-blue-600 hover:bg-blue-500 text-white', buttonSecondary: 'bg-slate-800 hover:bg-slate-700 text-blue-400 border border-slate-600', inputBg: 'bg-slate-800', inputBorder: 'border-slate-600 focus:border-blue-500', cardBg: 'bg-slate-800', cardBorder: 'border-slate-700', fileInputBtn: 'file:bg-slate-700 file:text-blue-400 hover:file:bg-slate-600', isDark: true }
        };

        // --- SAFE ICON COMPONENT ---
        const Icon = ({ name, className = "w-4 h-4", onClick }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current) {
                    ref.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    i.setAttribute('class', className);
                    ref.current.appendChild(i);
                    lucide.createIcons({ root: ref.current });
                }
            }, [name, className]);
            return <span ref={ref} onClick={onClick} className="inline-flex items-center justify-center cursor-pointer"></span>;
        };

        // --- HELPER FUNCTIONS ---
        const addTag = (currentVal, setter, text) => {
            let newVal = currentVal || "";
            let textToAdd = text;
            newVal = newVal.trimEnd();
            if (newVal.length > 0 && !newVal.endsWith(".") && !newVal.endsWith("\n")) {
                if (!newVal.endsWith(",")) newVal += ", ";
                else newVal += " ";
                textToAdd = text.charAt(0).toLowerCase() + text.slice(1);
            } else if (newVal.length > 0) {
                newVal += " ";
            }
            setter(newVal + textToAdd);
        };

        const formatTime = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `[${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}]`;
        };

        // --- AI HELPER FUNCTION ---
        const callGeminiAI = async (apiKey, text, type) => {
            if (!text.trim()) return text;
            
            const prompt = type === 'pros' 
                ? `Bạn là một giáo viên tiểu học thân thiện. Hãy viết lại các ý nhận xét ưu điểm sau đây thành một câu văn mạch lạc, giọng điệu khen ngợi, khích lệ: "${text}"`
                : `Bạn là một giáo viên tiểu học ân cần. Hãy viết lại các ý góp ý sau đây thành một câu văn nhẹ nhàng, mang tính xây dựng, giúp học sinh sửa lỗi mà không bị tổn thương: "${text}"`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || text;
            } catch (error) {
                console.error("AI Error:", error);
                throw error;
            }
        };

        // --- COMPONENTS ---
        const SettingsModal = ({ isOpen, onClose, apiKey, setApiKey }) => {
            const [keyInput, setKeyInput] = useState(apiKey);

            useEffect(() => { setKeyInput(apiKey); }, [apiKey, isOpen]);

            if (!isOpen) return null;

            const handleSave = () => {
                setApiKey(keyInput);
                localStorage.setItem("gemini_api_key", keyInput);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-xl p-6 w-96 shadow-2xl animate-fade-in">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-lg flex items-center gap-2"><Icon name="cpu" className="w-5 h-5 text-purple-600" /> Cài Đặt AI</h3>
                            <button onClick={onClose}><Icon name="x" className="w-5 h-5 text-gray-400 hover:text-red-500" /></button>
                        </div>
                        <div className="mb-4">
                            <label className="block text-sm font-bold text-gray-700 mb-2">Google Gemini API Key:</label>
                            <input 
                                type="password" 
                                value={keyInput}
                                onChange={(e) => setKeyInput(e.target.value)}
                                className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none text-sm"
                                placeholder="Dán API Key vào đây..."
                            />
                            <p className="text-xs text-gray-500 mt-2">
                                Bạn cần có API Key để sử dụng tính năng "Viết lại bằng AI".
                                <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-blue-600 hover:underline ml-1">Lấy Key tại đây</a>.
                            </p>
                        </div>
                        <button onClick={handleSave} className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 rounded-lg transition-colors">Lưu Cài Đặt</button>
                    </div>
                </div>
            );
        };

        const AIButton = ({ text, onResult, type, apiKey, openSettings }) => {
            const [isLoading, setIsLoading] = useState(false);

            const handleAI = async () => {
                if (!apiKey) {
                    alert("Vui lòng nhập API Key trong phần Cài đặt để dùng tính năng này!");
                    openSettings();
                    return;
                }
                if (!text.trim()) {
                    alert("Hãy nhập vài ý chính trước khi nhờ AI viết lại nhé!");
                    return;
                }

                setIsLoading(true);
                try {
                    const result = await callGeminiAI(apiKey, text, type);
                    onResult(result.trim());
                } catch (error) {
                    alert("Lỗi khi gọi AI. Vui lòng kiểm tra lại API Key hoặc kết nối mạng.");
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <button 
                    onClick={handleAI} 
                    disabled={isLoading}
                    className={`p-1.5 rounded-full border transition-all ${isLoading ? 'bg-yellow-100 border-yellow-300 ai-loading' : 'bg-white hover:bg-yellow-50 text-yellow-600 border-yellow-200'}`} 
                    title="AI Viết Lại (Viết hay hơn)"
                >
                    <Icon name="sparkles" className="w-4 h-4" />
                </button>
            );
        };

        const VoiceButton = ({ onTranscript, isDark }) => {
            const [isListening, setIsListening] = useState(false);
            const recognitionRef = useRef(null);

            useEffect(() => {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognitionRef.current = new SpeechRecognition();
                    recognitionRef.current.lang = 'vi-VN';
                    recognitionRef.current.continuous = false;
                    recognitionRef.current.interimResults = false;
                    recognitionRef.current.onstart = () => setIsListening(true);
                    recognitionRef.current.onend = () => setIsListening(false);
                    recognitionRef.current.onresult = (event) => onTranscript(event.results[0][0].transcript);
                }
            }, [onTranscript]);

            const toggle = () => {
                if (!recognitionRef.current) return alert("Dùng Chrome/Edge để hỗ trợ giọng nói.");
                isListening ? recognitionRef.current.stop() : recognitionRef.current.start();
            };

            const btnClass = isListening 
                ? 'bg-red-500 text-white mic-active border-red-500' 
                : isDark 
                    ? 'bg-slate-700 hover:bg-slate-600 text-slate-300 border-slate-600'
                    : 'bg-white hover:bg-blue-50 text-slate-500 hover:text-blue-500 border-slate-200';

            return (
                <button onClick={toggle} className={`p-1.5 rounded-full border transition-all ${btnClass}`} title="Nhập giọng nói">
                    <Icon name={isListening ? "mic-off" : "mic"} className="w-4 h-4" />
                </button>
            );
        };

        const TimestampButton = ({ videoRef, contentState, setContent, isDark }) => {
            const insertTime = () => {
                if (videoRef.current) {
                    const timeTag = formatTime(videoRef.current.currentTime);
                    const newVal = (contentState || "").trimEnd();
                    const separator = (newVal.length > 0 && !newVal.endsWith("\n")) ? " " : "";
                    setContent(newVal + separator + timeTag + " ");
                } else {
                    alert("Chưa có video đang phát!");
                }
            };
            const btnClass = isDark
                ? 'bg-slate-700 hover:bg-slate-600 text-purple-400 border-slate-600'
                : 'bg-white hover:bg-purple-50 text-purple-500 border-purple-200';
            return (
                <button onClick={insertTime} className={`p-1.5 rounded-full border transition-all ${btnClass}`} title="Chèn thời gian">
                    <Icon name="clock" className="w-4 h-4" />
                </button>
            );
        };

        const SimpleInputSection = ({ title, iconName, color, tags, state, setState, videoRef, theme, apiKey, openSettings, type }) => {
            const colorClasses = {
                green: { 
                    bg: theme.isDark ? "bg-emerald-900/20" : "bg-emerald-50", 
                    border: theme.isDark ? "border-emerald-800" : "border-emerald-200", 
                    text: theme.isDark ? "text-emerald-400" : "text-emerald-700", 
                    chip: theme.isDark ? "bg-emerald-900 text-emerald-300 border-emerald-800 hover:bg-emerald-800" : "bg-white border-emerald-200 text-emerald-700 hover:bg-emerald-100" 
                },
                blue: { 
                    bg: theme.isDark ? "bg-blue-900/20" : "bg-blue-50", 
                    border: theme.isDark ? "border-blue-800" : "border-blue-200", 
                    text: theme.isDark ? "text-blue-400" : "text-blue-700", 
                    chip: theme.isDark ? "bg-blue-900 text-blue-300 border-blue-800 hover:bg-blue-800" : "bg-white border-blue-200 text-blue-700 hover:bg-blue-100" 
                } 
            }[color];

            const handleAppend = (text, currentVal, setter) => {
                let newVal = currentVal || "";
                if (newVal && !newVal.endsWith(" ")) newVal += " ";
                setter(newVal + text);
            };

            return (
                <div className={`rounded-xl p-4 border ${colorClasses.bg} ${colorClasses.border} flex flex-col h-full shadow-sm transition-colors`}>
                    <div className="flex justify-between items-center mb-3">
                        <div className="flex items-center gap-2">
                            <Icon name={iconName} className={`w-5 h-5 ${color === 'green' ? 'text-emerald-500' : 'text-blue-500'}`} />
                            <h3 className={`font-bold text-lg ${colorClasses.text}`}>{title}</h3>
                        </div>
                        <div className="flex gap-2">
                            <AIButton text={state} onResult={setState} type={type} apiKey={apiKey} openSettings={openSettings} />
                            <TimestampButton videoRef={videoRef} contentState={state} setContent={setState} isDark={theme.isDark} />
                            <VoiceButton onTranscript={(txt) => handleAppend(txt, state, setState)} isDark={theme.isDark} />
                        </div>
                    </div>
                    
                    <div className="mb-3">
                        {Object.entries(tags).map(([category, items]) => (
                            <div key={category} className="mb-2 last:mb-0">
                                <div className={`text-[10px] font-bold uppercase opacity-60 mb-1 ${theme.textSub}`}>{category}</div>
                                <div className="flex flex-wrap gap-1.5">
                                    {items.map((t, i) => (
                                        <button key={i} onClick={() => addTag(state, setState, t)} className={`chip text-xs px-3 py-1.5 rounded-full border shadow-sm font-medium ${colorClasses.chip}`}>
                                            + {t}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>

                    <textarea 
                        value={state} 
                        onChange={e => setState(e.target.value)} 
                        className={`w-full flex-grow p-4 text-base border rounded-xl focus:outline-none focus:ring-2 focus:ring-opacity-50 resize-none shadow-inner transition-colors ${theme.inputBg} ${theme.inputBorder} ${theme.textMain} placeholder-gray-400`}
                        placeholder={`Nhập nhận xét...`}
                    ></textarea>
                </div>
            );
        };

        function App() {
            const [currentThemeId, setCurrentThemeId] = useState(() => localStorage.getItem("app_theme_v17") || 'blue');
            const theme = THEMES[currentThemeId];

            const [folders, setFolders] = useState(() => {
                const saved = localStorage.getItem("video_reviews_data_v24");
                const oldSaved = localStorage.getItem("video_reviews_data_v23");
                if (saved) return JSON.parse(saved);
                if (oldSaved) return JSON.parse(oldSaved);
                return [{ id: 'default_1', name: 'Lớp 5A', reviews: [] }];
            });
            const [activeFolderId, setActiveFolderId] = useState(() => localStorage.getItem("active_folder_id_v24") || folders[0].id);
            
            const [currentFile, setCurrentFile] = useState(null);
            const [videoUrl, setVideoUrl] = useState(null);
            const [presenterName, setPresenterName] = useState("");

            const [pros, setPros] = useState("");
            const [cons, setCons] = useState("");
            const [searchTerm, setSearchTerm] = useState("");
            
            // --- EDIT MODE STATE ---
            const [editingKey, setEditingKey] = useState(null);

            // --- API KEY STATE ---
            const [apiKey, setApiKey] = useState(() => localStorage.getItem("gemini_api_key") || "");
            const [showSettings, setShowSettings] = useState(false);

            const videoRef = useRef(null);
            const fileInputRef = useRef(null);
            
            const activeFolder = folders.find(f => f.id === activeFolderId) || folders[0];
            const reviews = activeFolder.reviews;

            const filteredReviews = useMemo(() => {
                return reviews.filter(r => 
                    r.presenter.toLowerCase().includes(searchTerm.toLowerCase()) || 
                    (r.fileName && r.fileName.toLowerCase().includes(searchTerm.toLowerCase()))
                );
            }, [reviews, searchTerm]);

            const suggestionTags = {
                pros: {
                    "Kiến Thức": ["Em nắm chắc nội dung bài học", "Biết mở rộng kiến thức thực tế", "Sử dụng từ ngữ chính xác", "Bố cục bài nói rõ ràng", "Phân tích sơ đồ logic"],
                    "Kỹ Năng": ["Giọng nói to, rõ ràng", "Phong thái tự tin, chững chạc", "Tương tác mắt tốt với người nghe", "Kết hợp cử chỉ tay tự nhiên", "Làm chủ tốt thời gian"]
                },
                cons: {
                    "Nội Dung": ["Em cần tìm hiểu kỹ hơn sơ đồ", "Nên sắp xếp ý mạch lạc hơn", "Cần mở rộng thêm ví dụ thực tế", "Tránh lặp lại ý"],
                    "Phong Thái": ["Cần tự tin hơn khi trình bày", "Nên nói to hơn để cả lớp cùng nghe", "Hạn chế nhìn vào tài liệu", "Cần tương tác nhiều hơn với người nghe"],
                    "Hình Thức": ["Chú ý vị trí đứng không che bảng", "Thao tác chỉ que cần dứt khoát hơn", "Cần giữ máy quay ổn định", "Chú ý ánh sáng khi quay"]
                }
            };

            // Sync Theme & Save Data
            useEffect(() => {
                localStorage.setItem("app_theme_v17", currentThemeId);
                document.body.className = theme.bg;
            }, [currentThemeId, theme]);

            useEffect(() => {
                localStorage.setItem("video_reviews_data_v24", JSON.stringify(folders));
                localStorage.setItem("active_folder_id_v24", activeFolderId);
            }, [folders, activeFolderId]);

            // Handlers
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setCurrentFile(file);
                    setVideoUrl(URL.createObjectURL(file));
                    if (!editingKey) { 
                        setPros(""); setCons("");
                        setPresenterName(file.name.replace(/\.[^/.]+$/, ""));
                    }
                }
            };

            const createFolder = () => {
                const name = prompt("Tên lớp mới (ví dụ: Lớp 5B):");
                if (name) {
                    const newF = { id: 'f_' + Date.now(), name, reviews: [] };
                    setFolders([...folders, newF]); setActiveFolderId(newF.id);
                }
            };
            const renameFolder = () => {
                const name = prompt("Đổi tên lớp:", activeFolder.name);
                if (name) setFolders(folders.map(f => f.id === activeFolderId ? { ...f, name } : f));
            };
            const deleteFolder = () => {
                if (folders.length <= 1) return alert("Giữ lại ít nhất 1 lớp!");
                if (confirm("Xóa lớp này?")) {
                    const rem = folders.filter(f => f.id !== activeFolderId);
                    setFolders(rem); setActiveFolderId(rem[0].id);
                }
            };

            // --- BACKUP & RESTORE FUNCTIONS ---
            const handleExportData = () => {
                const dataStr = JSON.stringify(folders, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `Du_Lieu_Cham_Bai_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleImportData = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (Array.isArray(importedData)) {
                            if (confirm("Bạn có chắc muốn khôi phục dữ liệu? Dữ liệu hiện tại sẽ bị thay thế.")) {
                                setFolders(importedData);
                                setActiveFolderId(importedData[0]?.id);
                                alert("Khôi phục dữ liệu thành công!");
                            }
                        } else {
                            alert("File dữ liệu không hợp lệ.");
                        }
                    } catch (err) {
                        alert("Lỗi khi đọc file: " + err.message);
                    }
                };
                reader.readAsText(file);
                e.target.value = null;
            };

            // --- SAVE / UPDATE LOGIC ---
            const handleSave = () => {
                if (!presenterName) return alert("Vui lòng nhập tên học sinh!");
                if (!editingKey && !currentFile && !presenterName) return alert("Chưa có video hoặc tên học sinh!");

                if (editingKey) {
                    const updatedFolders = folders.map(f => {
                        if (f.id === activeFolderId) {
                            return {
                                ...f,
                                reviews: f.reviews.map(r => {
                                    if (r.key === editingKey) {
                                        return {
                                            ...r,
                                            presenter: presenterName,
                                            pros: pros,
                                            cons: cons,
                                            fileName: currentFile ? currentFile.name : r.fileName
                                        };
                                    }
                                    return r;
                                })
                            };
                        }
                        return f;
                    });
                    setFolders(updatedFolders);
                    setEditingKey(null);
                    alert("Đã cập nhật thành công!");
                } else {
                    const newId = (reviews.length > 0 ? Math.max(...reviews.map(r => r.id)) : 0) + 1;
                    const newRev = {
                        key: Date.now(), id: newId, 
                        fileName: currentFile?.name || "N/A", 
                        presenter: presenterName || "Học sinh",
                        pros: pros, cons: cons,
                        date: new Date().toLocaleString('vi-VN')
                    };
                    setFolders(folders.map(f => f.id === activeFolderId ? { ...f, reviews: [newRev, ...f.reviews] } : f));
                    alert(`Đã lưu bài của em ${presenterName}!`);
                }
                setPros(""); setCons(""); setPresenterName(""); setEditingKey(null); 
            };

            const handleEdit = (review) => {
                setEditingKey(review.key);
                setPresenterName(review.presenter);
                setPros(review.pros);
                setCons(review.cons);
                alert(`Đang sửa bài của: ${review.presenter}`);
            };

            const cancelEdit = () => {
                setEditingKey(null);
                setPros(""); setCons(""); setPresenterName("");
            };

            const exportAllExcel = () => {
                const wb = XLSX.utils.book_new();
                folders.forEach(f => {
                    if(!f.reviews.length) return;
                    const data = [...f.reviews].sort((a,b)=>a.id-b.id).map(r => ({
                        "STT": r.id, 
                        "Học Sinh": r.presenter, 
                        "Ưu Điểm": r.pros, 
                        "Góp Ý": r.cons
                    }));
                    const ws = XLSX.utils.json_to_sheet(data);
                    // Updated cols: STT(5), Name(25), Pros(50), Cons(50)
                    ws['!cols'] = [{wch:5}, {wch:25}, {wch:50}, {wch:50}];
                    let sheetName = f.name.replace(/[\\/?*[\]]/g,"").slice(0,30);
                    if(wb.SheetNames.includes(sheetName)) sheetName += `_${f.id.slice(-3)}`;
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                });
                XLSX.writeFile(wb, `Danh_Gia_Hoc_Sinh_${new Date().getTime()}.xlsx`);
            };

            // Video height calculation
            const videoHeightClass = "h-[60vh] min-h-[400px]";

            return (
                <div className={`min-h-screen p-4 flex flex-col ${theme.bg} transition-colors duration-300`}>
                    <div className="w-full mx-auto space-y-6 flex-grow flex flex-col">
                        
                        {/* HEADER */}
                        <div className={`${theme.headerBg} p-4 rounded-xl shadow-sm border ${theme.headerBorder} flex flex-col lg:flex-row justify-between items-center gap-4 shrink-0 transition-colors`}>
                            <h1 className={`text-2xl font-bold ${theme.textMain} flex items-center gap-3`}>
                                <span className={`${theme.accentBg} p-2 rounded-xl`}>
                                    <Icon name="check-square" className={`w-8 h-8 ${theme.accent}`} />
                                </span>
                                Chấm Video Thuyết Trình
                            </h1>

                            <div className="flex flex-wrap justify-center items-center gap-4">
                                {/* Settings & Data */}
                                <div className="flex gap-2">
                                    <button onClick={() => setShowSettings(true)} className={`p-2 ${theme.textSub} hover:${theme.accentBg} rounded-lg`} title="Cài đặt AI"><Icon name="settings" className="w-5 h-5" /></button>
                                    <button onClick={handleExportData} className={`p-2 ${theme.textSub} hover:${theme.accentBg} rounded-lg`} title="Sao lưu dữ liệu"><Icon name="download" className="w-5 h-5" /></button>
                                    <label className={`p-2 ${theme.textSub} hover:${theme.accentBg} rounded-lg cursor-pointer`} title="Khôi phục dữ liệu">
                                        <Icon name="upload" className="w-5 h-5" />
                                        <input type="file" accept=".json" onChange={handleImportData} className="hidden" ref={fileInputRef} />
                                    </label>
                                </div>

                                <div className={`h-6 w-px ${theme.isDark ? 'bg-slate-600' : 'bg-slate-200'}`}></div>

                                {/* Theme Selector */}
                                <div className={`flex items-center gap-2 ${theme.accentBg} p-2 rounded-xl border ${theme.headerBorder}`}>
                                    {Object.values(THEMES).map(t => (
                                        <button 
                                            key={t.id}
                                            onClick={() => setCurrentThemeId(t.id)}
                                            className={`w-6 h-6 rounded-full border-2 transition-all ${currentThemeId === t.id ? 'border-blue-500 scale-125 shadow-md' : 'border-transparent opacity-70 hover:opacity-100'}`}
                                            style={{ backgroundColor: t.isDark ? '#334155' : (t.id === 'blue' ? '#3b82f6' : t.id === 'rose' ? '#f43f5e' : t.id === 'teal' ? '#14b8a6' : '#f59e0b') }}
                                            title={t.name}
                                        ></button>
                                    ))}
                                </div>

                                {/* Folder Tools */}
                                <div className={`flex items-center gap-3 ${theme.isDark ? 'bg-slate-700' : 'bg-slate-100'} p-2 rounded-xl border ${theme.headerBorder}`}>
                                    <Icon name="folder-open" className={`w-5 h-5 ${theme.textSub}`} />
                                    <select value={activeFolderId} onChange={e=>setActiveFolderId(e.target.value)} className={`bg-transparent font-bold ${theme.textMain} outline-none cursor-pointer min-w-[150px] text-lg`}>
                                        {folders.map(f => <option key={f.id} value={f.id} className={theme.isDark ? 'bg-slate-800' : ''}>{f.name} ({f.reviews.length})</option>)}
                                    </select>
                                    <div className={`h-6 w-px ${theme.isDark ? 'bg-slate-600' : 'bg-slate-300'} mx-2`}></div>
                                    <button onClick={createFolder} className={`p-2 ${theme.textMain} hover:${theme.accentBg} rounded-lg`} title="Tạo lớp mới"><Icon name="plus" className="w-5 h-5" /></button>
                                    <button onClick={renameFolder} className={`p-2 ${theme.textMain} hover:${theme.accentBg} rounded-lg`} title="Đổi tên lớp"><Icon name="pencil" className="w-5 h-5" /></button>
                                    <button onClick={deleteFolder} className={`p-2 text-red-500 hover:bg-red-50 rounded-lg`} title="Xóa lớp"><Icon name="trash-2" className="w-5 h-5" /></button>
                                </div>
                            </div>
                        </div>

                        {/* TOP SECTION: VIDEO & FORM (SIDE BY SIDE) */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            
                            {/* LEFT: VIDEO PLAYER */}
                            <div className={`rounded-2xl shadow-lg overflow-hidden flex flex-col border ${theme.isDark ? 'border-slate-700 bg-slate-800' : 'border-slate-200 bg-white'} ${videoHeightClass}`}>
                                <div className="flex-grow flex items-center justify-center bg-black min-h-0 relative">
                                    {videoUrl ? (
                                        <video ref={videoRef} src={videoUrl} controls className="w-full h-full object-contain" />
                                    ) : (
                                        <div className="text-gray-500 text-center flex flex-col items-center p-10">
                                            <Icon name="upload" className="w-16 h-16 mb-4 opacity-50 text-white" />
                                            <p className="text-lg text-slate-400">Chọn video để bắt đầu</p>
                                        </div>
                                    )}
                                </div>
                                <div className={`p-4 border-t ${theme.isDark ? 'border-slate-700 bg-slate-800' : 'border-slate-100 bg-white'} shrink-0 z-10 flex items-center justify-between`}>
                                    <label className={`cursor-pointer px-6 py-2.5 rounded-full text-sm font-bold shadow-md transition-all active:scale-95 ${theme.buttonPrimary} flex items-center gap-2`}>
                                        <Icon name="folder-up" className="w-5 h-5" />
                                        <span>{currentFile ? "Đổi Video Khác" : "Chọn Video Bài Làm"}</span>
                                        <input type="file" accept="video/*" onChange={handleFileChange} onClick={e=>e.target.value=null} className="hidden" />
                                    </label>
                                    {currentFile && <span className={`text-sm truncate max-w-[200px] ${theme.textSub} font-medium`}>{currentFile.name}</span>}
                                </div>
                            </div>

                            {/* RIGHT: INPUT FORM */}
                            <div className={`${theme.cardBg} rounded-2xl shadow-lg border ${theme.cardBorder} flex flex-col overflow-hidden transition-colors ${videoHeightClass} relative`}>
                                {editingKey && (
                                    <div className="absolute top-0 left-0 w-full bg-orange-100 text-orange-700 px-4 py-1 text-xs font-bold text-center z-20 border-b border-orange-200 flex justify-between items-center">
                                        <span>ĐANG CHỈNH SỬA: {presenterName}</span>
                                        <button onClick={cancelEdit} className="hover:text-red-600 underline">Hủy Bỏ</button>
                                    </div>
                                )}
                                
                                {/* Name Input */}
                                <div className={`p-5 border-b ${theme.isDark ? 'border-slate-700 bg-slate-800' : 'border-slate-100 bg-slate-50'} shrink-0 mt-${editingKey ? '6' : '0'}`}>
                                    <label className={`block text-xs font-bold uppercase mb-2 ml-1 ${theme.textSub}`}>Họ và tên học sinh:</label>
                                    <input type="text" value={presenterName} onChange={e=>setPresenterName(e.target.value)} placeholder="Nhập tên học sinh..." className={`w-full ${theme.inputBg} border ${theme.inputBorder} rounded-xl px-5 py-3 font-bold text-xl focus:ring-2 focus:ring-opacity-50 focus:outline-none ${theme.textMain} placeholder-slate-400 shadow-sm`} />
                                </div>

                                {/* Review Boxes */}
                                <div className={`flex-grow overflow-y-auto p-5 space-y-6 custom-scrollbar ${theme.isDark ? 'bg-slate-900/50' : 'bg-slate-50/30'}`}>
                                    <div className="h-[400px]"> 
                                        <SimpleInputSection title="Ưu Điểm" iconName="check-circle-2" color="green" tags={suggestionTags.pros} state={pros} setState={setPros} videoRef={videoRef} theme={theme} apiKey={apiKey} openSettings={()=>setShowSettings(true)} type="pros" />
                                    </div>
                                    <div className="h-[400px]"> 
                                        <SimpleInputSection title="Góp Ý / Hạn Chế" iconName="message-circle" color="blue" tags={suggestionTags.cons} state={cons} setState={setCons} videoRef={videoRef} theme={theme} apiKey={apiKey} openSettings={()=>setShowSettings(true)} type="cons" />
                                    </div>
                                </div>

                                {/* Footer Save */}
                                <div className={`p-4 border-t ${theme.isDark ? 'border-slate-700 bg-slate-800' : 'border-slate-100 bg-slate-50'} flex justify-end items-center shrink-0 shadow-inner z-10`}>
                                    <div className="flex gap-2">
                                        {editingKey && (
                                            <button onClick={cancelEdit} className="px-6 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-200 transition-all">Hủy</button>
                                        )}
                                        <button onClick={handleSave} className={`${theme.buttonPrimary} px-8 py-3 rounded-xl font-bold shadow-lg flex items-center gap-2 transform active:scale-95 transition-all`}>
                                            <Icon name={editingKey ? "rotate-ccw" : "save"} className="w-5 h-5" /> {editingKey ? "CẬP NHẬT" : "LƯU KẾT QUẢ"}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* BOTTOM SECTION: LIST (FULL WIDTH) */}
                        <div className={`${theme.cardBg} rounded-2xl shadow-lg border ${theme.cardBorder} p-6 flex flex-col transition-colors min-h-[300px]`}>
                            <div className="flex flex-col md:flex-row justify-between items-center mb-4 shrink-0 gap-3">
                                <h2 className={`font-bold text-xl ${theme.textMain} flex items-center gap-3`}>
                                    <Icon name="list" className={`w-6 h-6 ${theme.textSub}`} /> 
                                    Danh Sách Đã Chấm ({filteredReviews.length})
                                </h2>
                                
                                <div className="flex items-center gap-3 w-full md:w-auto">
                                    {/* Search Input */}
                                    <div className={`flex items-center gap-2 ${theme.inputBg} border ${theme.inputBorder} px-3 py-2 rounded-lg w-full md:w-64 transition-colors`}>
                                        <Icon name="search" className={`w-4 h-4 ${theme.textSub}`} />
                                        <input 
                                            type="text" 
                                            placeholder="Tìm tên học sinh..." 
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                            className={`bg-transparent outline-none text-sm w-full ${theme.textMain} placeholder-gray-400`}
                                        />
                                        {searchTerm && (
                                            <button onClick={() => setSearchTerm("")} className="text-gray-400 hover:text-red-500">
                                                <Icon name="x" className="w-4 h-4" />
                                            </button>
                                        )}
                                    </div>

                                    <button onClick={exportAllExcel} className={`${theme.buttonSecondary} px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 shadow-sm transition-all hover:shadow-md whitespace-nowrap`}>
                                        <Icon name="file-spreadsheet" className="w-4 h-4" /> Xuất Excel
                                    </button>
                                </div>
                            </div>
                            
                            {/* Table Container */}
                            <div className="overflow-x-auto custom-scrollbar flex-grow rounded-xl border border-slate-200/50">
                                <table className="w-full text-left border-collapse">
                                    <thead className={`${theme.isDark ? 'bg-slate-700 text-slate-300' : 'bg-slate-100 text-slate-600'} uppercase font-bold text-sm sticky top-0 z-10`}>
                                        <tr>
                                            <th className="px-4 py-4 text-center w-16">#</th>
                                            <th className="px-4 py-4 w-1/4">Học Sinh</th>
                                            <th className="px-4 py-4 w-1/3">Ưu Điểm</th>
                                            <th className="px-4 py-4 w-1/3">Góp Ý</th>
                                            <th className="px-4 py-4 text-center w-24">Thao Tác</th>
                                        </tr>
                                    </thead>
                                    <tbody className={`divide-y ${theme.isDark ? 'divide-slate-700' : 'divide-slate-100'} text-sm`}>
                                        {filteredReviews.length === 0 ? <tr><td colSpan="6" className={`text-center py-12 ${theme.textSub} italic text-lg`}>Không tìm thấy kết quả</td></tr> : 
                                        [...filteredReviews].reverse().map(r => (
                                            <tr key={r.key} className={`${theme.isDark ? 'hover:bg-slate-700' : 'hover:bg-blue-50'} group transition-colors`}>
                                                <td className={`px-4 py-4 text-center ${theme.textSub} font-mono`}>{r.id}</td>
                                                <td className={`px-4 py-4 font-bold ${theme.textMain} align-top`}>
                                                    <div className="text-base">{r.presenter}</div>
                                                    <div className={`text-xs ${theme.textSub} mt-1 font-normal`}>{r.date}</div>
                                                    {r.fileName !== "N/A" && <div className={`text-xs ${theme.textSub} mt-0.5 truncate max-w-[200px]`}>File: {r.fileName}</div>}
                                                </td>
                                                <td className={`px-4 py-4 ${theme.textMain} whitespace-pre-line align-top leading-relaxed`}>{r.pros}</td>
                                                <td className={`px-4 py-4 ${theme.textMain} whitespace-pre-line align-top leading-relaxed`}>{r.cons}</td>
                                                <td className="px-4 py-4 text-center align-top pt-4">
                                                    <div className="flex justify-center gap-1">
                                                        <button onClick={() => handleEdit(r)} className="text-slate-400 hover:text-blue-500 p-2 rounded-full hover:bg-blue-50 transition-all" title="Sửa"><Icon name="pencil" className="w-4 h-4" /></button>
                                                        <button onClick={() => {if(confirm("Xóa nhận xét này?")) setFolders(folders.map(f=>f.id===activeFolderId?{...f,reviews:f.reviews.filter(rev=>rev.key!==r.key)}:f))}} className="text-slate-400 hover:text-red-500 p-2 rounded-full hover:bg-red-50 transition-all" title="Xóa"><Icon name="trash-2" className="w-4 h-4" /></button>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <SettingsModal isOpen={showSettings} onClose={() => setShowSettings(false)} apiKey={apiKey} setApiKey={setApiKey} />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
